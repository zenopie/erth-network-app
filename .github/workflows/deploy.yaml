name: Deploy to Remote Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy and Run on Remote Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_SERVER_HOST }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e # Exit immediately on error

            # --- Configuration ---
            REPO_DIR=/home/secret/erth-mainnet-app
            # Define the server directory path
            SERVER_DIR=$REPO_DIR/server
            FRONTEND_DEPLOY_DIR=/var/www/erth

            # --- Repository Setup ---
            echo ">>> 1. Setting up repository in $REPO_DIR"
            mkdir -p $REPO_DIR
            cd $REPO_DIR

            if [ -d ".git" ]; then
              echo "Repository exists. Pulling latest changes..."
              git fetch origin main
              git reset --hard origin/main
              git clean -fd
            else
              echo "Cloning new repository..."
              git clone https://github.com/zenopie/erth-mainnet-app.git .
            fi

            # --- Frontend Build (if it exists at the root) ---
            echo ">>> 2. Building Frontend"
            if [ -f "package.json" ]; then
              export NVM_DIR="$HOME/.nvm"
              if [ ! -s "$NVM_DIR/nvm.sh" ]; then
                curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
              fi
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              
              nvm install 18
              nvm use 18
              
              npm install
              npm run build
              
              echo "Deploying frontend to $FRONTEND_DEPLOY_DIR"
              mkdir -p $FRONTEND_DEPLOY_DIR
              # Adjust 'build' to your actual build output directory if different
              cp -r build/* $FRONTEND_DEPLOY_DIR/
            else
              echo "WARNING: package.json not found at root. Skipping frontend build."
            fi

            # --- Backend Deployment (Docker) ---
            echo ">>> 3. Setting up Backend"

            # Check if the server directory exists
            if [ ! -d "$SERVER_DIR" ]; then
              echo "ERROR: Server directory not found at $SERVER_DIR!"
              exit 1
            fi

            # Securely create the WALLET_KEY.txt inside the server directory
            echo "Creating WALLET_KEY.txt in $SERVER_DIR..."
            echo "${{ secrets.WALLET_KEY_SECRET }}" > $SERVER_DIR/WALLET_KEY.txt
            if [ ! -s "$SERVER_DIR/WALLET_KEY.txt" ]; then
              echo "ERROR: WALLET_KEY.txt is empty. Ensure WALLET_KEY_SECRET is set in GitHub."
              exit 1
            fi
            
            # Ensure Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "Docker not found. Installing..."
              sudo apt-get update
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker ${{ secrets.REMOTE_SERVER_USERNAME }}
            fi

            echo "Building and running Docker container from $SERVER_DIR..."
            # Change directory to the server directory. This sets the "build context" for Docker.
            cd $SERVER_DIR

            # Stop and remove the old container
            docker stop erth-network-server || true
            docker rm erth-network-server   || true

            # Build the new image. The '.' refers to the current directory ($SERVER_DIR)
            docker build -t erth-network-server .

            # Run the new container
            docker run -d \
              --name erth-network-server \
              -p 5000:5000 \
              --restart always \
              erth-network-server

            echo ">>> Deployment successful! <<<"